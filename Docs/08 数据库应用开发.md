# 数据库应用开发

[toc]

## 概述

* Spring Data 是一组用于简化数据访问的工程

  * https://spring.io/projects/spring-data
  * Spring Data JPA
  * **Spring Data JDBC**
  * ...

* 提供一组 `Repository`  接口

  * `Repository`模式：

  * `CrudRepository`：增删改查功能

    ```java
    public interface CrudRepository<T, ID> extends Repository<T, ID> {
      <S extends T> S save(S entity);    
      Optional<T> findById(ID primaryKey); 
      Iterable<T> findAll();               
      long count();                        
      void delete(T entity);               
      boolean existsById(ID primaryKey);
    ```

  * `PagingAndSortingRepository` ： 提供分页和排序功能

    ```java
    public interface PagingAndSortingRepository<T, ID> extends CrudRepository<T, ID> {
      Iterable<T> findAll(Sort sort);
      Page<T> findAll(Pageable pageable);
    }
    ```

  * 我们自己的访问数据库的接口应该继承上述接口

    ```java
    interface UserRepository extends CrudRepository<User, Long> {
      long countByLastName(String lastName);
      long deleteByLastName(String lastName);
    }
    ```

## `Spring Data JDBC` 

### 起步

* 创建工程
  * 打开 IDEA，选择新建工程，选择 `Spring Initializr`

  * 按下图填写项目信息

    <img src="images\配置 Spring Data JDBC 工程.png" style="zoom:50%;" />

  * 点击下一步，选择依赖

    <img src="images\选择 Data JDBC 工程依赖.png" style="zoom:50%;" />

  * 点下一步，填写项目名称和位置，然后点完成

* 准备 `MySQL` 数据库环境

  * 建立`testdb`数据库，并在 `src/main/resources/application.properties` 文件里添加如下配置

  ```pro
  spring.datasource.url=jdbc:mysql://localhost:3306/testdb?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai
  spring.datasource.username=root
  spring.datasource.password=root
  ```

  * 在 `src/main/resources` 下添加文件 `schema.sql`，内容如下。然后执行，在 `testdb` 库中创建表

    ```mysql
    create table users
    (
        id       varchar(50) not null,
        username varchar(30) not null,
        password varchar(20) not null,
        age      int,
        primary key (id)
    ) character set utf8
    ```

* 编写`java` 类和接口

  * 添加实体类 `User.java`

    ```java
    import org.springframework.data.annotation.Id;
    
    @Table("users")  // 如果表名与类名相同，此注解可以不写
    public class User {
        @Id
        private String id;
        private String username;
        private String password;
        private int age;
        
        // setter/getter/toString 略
    }
    ```

  * 添加接口 `UserRepository` ，内容如下

    ```java
    import org.springframework.data.repository.CrudRepository;
    
    public interface UserRepository extends CrudRepository<User, String> {
    }
    ```

  * 添加配置类 `PersistenceConfiguration`，内容如下

    ```java
    @Configuration
    public class PersistenceConfiguration {
        @Bean
        public ApplicationListener<BeforeSaveEvent<?>> idGenerator() {
            return event -> {
                Object entity = event.getEntity();
                if (entity instanceof User) {
                    ((User) entity).setId(UUID.randomUUID().toString());
                }
            };
        }
    }
    ```

* 运行程序，输出结果会包含以下信息

  ```
  []
  [User{id='9ada8e59-11f1-451f-937c-ab0cfdc7fcf5', username='admin', password='admin123'}]
  ```

### 查询方法

* 官方文档
  * https://docs.spring.io/spring-data/jdbc/docs/current/reference/html/#repositories.query-methods.details
  * https://docs.spring.io/spring-data/jdbc/docs/current/reference/html/#jdbc.query-methods
  * https://docs.spring.io/spring-data/jdbc/docs/current/reference/html/#repository-query-keywords
  * https://docs.spring.io/spring-data/jdbc/docs/current/reference/html/#repository-query-return-types
* 当按属性查询时
  * 
* 使用 `@Query`